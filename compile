#!/bin/sh
rm *.o *.cmx *.cmi
# rm *.cmo

FILES="Common.ml CommonRank.ml Monoid.ml Pattern.ml ReadPattern.ml WhichTest.ml CorePattern.ml Simulate.ml SimStep.ml SimCont.ml SimFlush.ml UnitTest.ml UnitTestStep.ml UnitTestCont.ml UnitTestFlush.ml Testab.ml Testnull.ml"

FILES2="Main.ml"

optPP_I="$(ocamlfind query -i-format type_conv) $(ocamlfind query -i-format sexplib)"
optPP="camlp4o $optPP_I pa_type_conv.cma pa_sexp_conv.cma"
optPACKAGE="camomile,core,type_conv,sexplib"
#optI=$(ocamlfind query -i-format sexplib)
#optL=$(ocamlfind query -l-format sexplib)

compileFile () {
#  echo ocamlfind ocamlopt $2 -w +A-4 -annot -pp "camlp4o -I `ocamlfind query type_conv` -I `ocamlfind query sexplib` pa_type_conv.cma pa_sexp_conv.cma" -I `ocamlfind query sexplib` -thread -package camomile,core,type_conv,sexplib /Users/chrisk/local//godi/lib/ocaml/pkg-lib/sexplib/sexplib.cmxa -c $1;
       ocamlfind ocamlopt $2 -w +A-4 -annot -pp "camlp4o -I `ocamlfind query type_conv` -I `ocamlfind query sexplib` pa_type_conv.cma pa_sexp_conv.cma" -I `ocamlfind query sexplib` -thread -package camomile,core,type_conv,sexplib /Users/chrisk/local/godi/lib/ocaml/pkg-lib/sexplib/sexplib.cmxa -c $1;
}

for i in $FILES; do
    if [ -r "${i}i" ]; then
        echo "${i}i";
        compileFile "${i}i"; 
        echo "$i"
        compileFile "$i"
    else
        echo "$i to ${i}i"
        compileFile "$i" -i  > ${i}i
    fi
done

for i in $FILES2; do
    echo "$i"
    compileFile "$i"
done

libs="common.cmx monoid.cmx pattern.cmx readPattern.cmx whichTest.cmx corePattern.cmx simulate.cmx"

ocamlfind ocamlopt -thread -o main -linkpkg -package "$optPACKAGE" $libs simStep.cmx main.cmx

rm UnitTest
ocamlfind ocamlopt -thread -o unitTest -linkpkg -package camomile,core,type_conv,sexplib common.cmx monoid.cmx pattern.cmx readPattern.cmx whichTest.cmx corePattern.cmx simulate.cmx unitTest.cmx

ocamlfind ocamlopt -thread -o unitTestStep -linkpkg -package "$optPACKAGE" $libs simStep.cmx unitTestStep.cmx

ocamlfind ocamlopt -thread -o unitTestCont -linkpkg -package "$optPACKAGE" $libs simStep.cmx simCont.cmx unitTestCont.cmx

ocamlfind ocamlopt -thread -o unitTestFlush -linkpkg -package "$optPACKAGE" $libs simStep.cmx simCont.cmx simFlush.cmx unitTestFlush.cmx

ocamlfind ocamlopt -thread -o testab -linkpkg -package "$optPACKAGE" $libs simStep.cmx testab.cmx

ocamlfind ocamlopt -thread -o testnull -linkpkg -package "$optPACKAGE" $libs simStep.cmx testnull.cmx

